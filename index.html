<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colony Counter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
        }
        label, input, button {
            display: block;
            margin-bottom: 10px;
        }
        button {
            padding: 10px;
        }
        #result {
            margin-top: 20px;
            background: #f9f9f9;
            padding: 15px;
            border: 1px solid #ddd;
        }
        #uploadedImage, #processedImage {
            display: block;
            margin-top: 20px;
            max-width: 100%;
        }
    </style>
</head>
<body>
    <h1>Colony Counter</h1>
    <label for="imageUpload">Upload Image:</label>
    <input type="file" id="imageUpload" accept="image/*">
    <button onclick="countColonies()">Count Colonies</button>
    <div id="result"></div>
    <canvas id="uploadedImage" style="display: none;"></canvas>
    <canvas id="processedImage"></canvas>
    <script src="https://docs.opencv.org/4.x/opencv.js"></script>
    <script>
        function countColonies() {
            const fileInput = document.getElementById("imageUpload");
            if (fileInput.files.length === 0) {
                alert("Please upload an image first.");
                return;
            }

            const img = new Image();
            img.src = URL.createObjectURL(fileInput.files[0]);
            img.onload = function () {
                const canvas = document.getElementById("uploadedImage");
                const processedCanvas = document.getElementById("processedImage");
                canvas.width = img.width;
                canvas.height = img.height;
                processedCanvas.width = img.width;
                processedCanvas.height = img.height;

                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);

                const src = cv.imread(canvas);
                const dst = new cv.Mat();

                // 이미지를 HSV로 변환하여 형광 및 비형광 부분 검출
                cv.cvtColor(src, src, cv.COLOR_RGBA2RGB, 0);
                cv.cvtColor(src, src, cv.COLOR_RGB2HSV, 0);

                // 형광 및 비형광 콜로니 영역 생성
                const lowerFluorescent = new cv.Mat(src.rows, src.cols, src.type(), [30, 100, 100, 0]);
                const upperFluorescent = new cv.Mat(src.rows, src.cols, src.type(), [90, 255, 255, 255]);
                const fluorescentMask = new cv.Mat();
                cv.inRange(src, lowerFluorescent, upperFluorescent, fluorescentMask);

                // 컨투어 검출
                const contours = new cv.MatVector();
                const hierarchy = new cv.Mat();
                cv.findContours(fluorescentMask, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                // 형광 콜로니 수 계산 및 표시
                let fluorescentCount = 0;
                for (let i = 0; i < contours.size(); i++) {
                    const color = new cv.Scalar(255, 0, 0);
                    cv.drawContours(dst, contours, i, color, 2, cv.LINE_8, hierarchy, 0);
                    fluorescentCount++;
                }

                // 결과 표시
                cv.imshow("processedImage", dst);
                document.getElementById("result").innerText = `Fluorescent Colonies Count: ${fluorescentCount}`;

                // 메모리 해제
                src.delete();
                dst.delete();
                fluorescentMask.delete();
                lowerFluorescent.delete();
                upperFluorescent.delete();
                contours.delete();
                hierarchy.delete();
            };
        }
    </script>
</body>
</html>
